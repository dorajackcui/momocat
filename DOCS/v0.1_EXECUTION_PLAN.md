# v0.1 具体 Task 执行案 (Spreadsheet-first 默认)

## Epic A：项目骨架与运行闭环（Electron + UI + 服务）

**A1. Monorepo/项目结构初始化**
*   **产出**：
    *   `apps/desktop`（Electron main/preload/renderer）
    *   `packages/core`（schema、纯逻辑、无 Electron 依赖）
    *   `packages/db`（SQLite 层或 repository）
*   **DoD（验收）**：
    *   `dev` 一条命令启动（桌面窗口 + 热更新至少 renderer）
    *   main ↔ renderer IPC 可跑通（ping/pong）

**A2. IPC 合约与类型化**
*   **任务**：
    *   定义 `ApiVersion = 1`
    *   `preload` 只暴露白名单 API（例如 `project.* / segment.* / importExport.*`）
    *   所有 IPC payload 带 `requestId`
*   **DoD**：
    *   TS 编译期约束：renderer 调用不存在的 IPC 会报错
    *   任何 IPC handler 都不直接抛裸 error（统一错误对象）

**A3. Worker 基础设施（为后续 TM/QA/导入大文件预留）**
*   **任务**：
    *   建一个通用 `JobManager`（startJob/cancelJob/onProgress）
    *   至少实现一个示例 job：`normalizeSegmentsJob`
*   **DoD**：
    *   renderer 能看到 progress 事件
    *   主线程不被阻塞（导入 1 万行示例时 UI 不冻结）

---

## Epic B：Token/Segment Schema（v0.1 最关键地基）

**B1. 定义 Token / Segment / Project 的 schema（packages/core）**
*   **Token 类型（v0.1 最小集）**：
    *   `text`
    *   `tag`（占位符/变量/不可删标记）
*   **Segment 最小字段**：
    *   `segmentId`（uuid）
    *   `sourceTokens: Token[]`
    *   `targetTokens: Token[]`
    *   `status: new | draft | confirmed`
    *   `meta: { rowRef, context?, srcHash?, matchKey? }`
    *   `tagsSignature`（从 sourceTokens 导出的签名）
*   **DoD**：
    *   提供 `serializeTokensToDisplayText()` / `parseDisplayTextToTokens()`（v0.1 可先只支持简单规则：把 `{...}` 识别成 tag）
    *   提供 `computeTagsSignature(tokens)`（稳定、可复现）

**B2. 归一化与哈希**
*   **任务**：
    *   `computeMatchKey(sourceTokens)`：用于匹配/重复句
    *   `computeSrcHash(matchKey + tagsSignature)`：用于 100%/传播基础
*   **DoD**：
    *   同一句在不同空白/大小写下 matchKey 稳定
    *   tags 改动会导致 hash 改动（避免错误 100% 命中）

---

## Epic C：存储层（SQLite + 迁移 + 备份骨架）

**C1. SQLite schema v1**
*   **表建议（v0.1 最小）**：
    *   `schema_version(version)`
    *   `project(id, name, srcLang, tgtLang, createdAt, updatedAt)`
    *   `segment(segmentId, projectId, orderIndex, sourceTokensJson, targetTokensJson, status, tagsSignature, matchKey, srcHash, metaJson, updatedAt)`
*   **索引（v0.1 最小）**：
    *   `idx_segment_project_order(projectId, orderIndex)`
    *   `idx_segment_project_srcHash(projectId, srcHash)`
*   **DoD**：
    *   启动时自动迁移（version 为空则建库）
    *   有导出 DB 备份文件的命令（哪怕是菜单按钮）

**C2. Repository 接口**
*   `ProjectRepo`: create/open/list
*   `SegmentRepo`: bulkInsert/update/getPage(query)/updateStatus
*   **DoD**：
    *   读取分页：支持 `limit/offset` 或基于 `orderIndex` 的窗口读取（给虚拟列表）

---

## Epic D：SpreadsheetFilter（Excel/CSV）导入导出可逆

**D1. 定义“表格协议”**
*   必需列：`id`, `source`, `target`, `status`
*   建议列：`context`, `tags`
*   **DoD**：给出一份 `sample.csv` 和 `sample.xlsx`

**D2. CSV 导入/导出**
*   **导入**：读表 -> 生成 Segment -> 解析 tokens
*   **导出**：逐行写回 `target/status/tags/id`
*   **DoD**：导入->不修改->导出 后，源列不丢行、不换序；id 稳定写回

**D3. Excel 导入/导出（XLSX）**
*   同 CSV，但支持选择 sheet
*   **DoD**：允许用户选择首行是否表头、列映射

---

## Epic E：UI（段列表 + Token-aware 编辑器 + 状态流转）

**E1. Segment 列表（虚拟滚动）**
*   显示：source、target、status、QA 占位
*   支持点击选中、上下段跳转
*   **DoD**：1 万段可顺滑滚动；支持 status 过滤

**E2. Token-aware 编辑器（最小实现）**
*   **要求**：tag 胶囊化展示，不可部分删除；BackSpace 整体删除胶囊。
*   **DoD**：`{name}` 不能删成 `{na`；复制粘贴暂存为纯文本。

**E3. 状态流转与快捷操作**
*   **操作**：保存自动变 `draft`，确认变 `confirmed` 并跳下一段。
*   **DoD**：confirmed 段落修改后自动回到 `draft`。

---

## Epic F：最小 QA（只做 Tag 完整性检查）

**F1. Tag 完整性（v0.1 minimal）**
*   **规则**：target 的 tagsSignature 必须与 source 一致。
*   **表现**：标红提示“缺少占位符/标签”。
*   **DoD**：人为删掉 `{name}` 能被检测出来。
