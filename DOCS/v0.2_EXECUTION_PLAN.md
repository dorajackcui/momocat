# v0.2（专业能力门槛）具体执行方案

## v0.2 目标（对应 roadmap 三项）

1. **Tag 校验与签名**：导出安全，不丢 tag、不乱 tag。
2. **TM 引擎增强**：working TM + 100% 命中 + 重复句传播（项目范围）。
3. **Concordance 搜索**：按 matchKey 做语境检索。

---

## Phase 1: Tag 校验与签名 (QA Error 级别)

### 1.1 统一 tagsSignature 生成与比较规则
- `computeTagsSignature(tokens)`: 对 sourceTokens 生成顺序敏感的签名。
- `extractTags(tokens)`: 用于 UI/QA 展示。
- 校验规则：Target 必须包含与 Source 完全一致的 Tag 序列。

### 1.2 QA 框架最小落地
- 设计 `QaIssue` 结构（ruleId, severity, message）。
- 实现 `TagIntegrityRule.run(segment)` 返回 issues。
- 编辑界面实时显示错误，导出时存在 Error 则阻止导出。

---

## Phase 2: TM 引擎增强 (100% + Propagation)

### 2.1 Working TM 写入
- `confirmSegment` 成功后写入 `tm_entries`。
- 采用 `upsert` 策略，按 `(projectId, srcHash)` 唯一。

### 2.2 100% 命中
- `query100(projectId, srcHash)`: 从 `tm_entries` 查找精确匹配。
- 编辑器右侧 TM 面板显示匹配结果并支持一键应用。

### 2.3 重复句传播 (Propagation)
- **触发点**：Confirm 当前段落后，自动填充本项目内所有相同 `srcHash` 的段落。
- **范围**：项目范围（跨文件）。
- **撤销**：记录 `batchId`，支持撤销最近一次传播。

---

## Phase 3: Concordance 搜索 (按 matchKey 的语境检索)

### 3.1 SQLite FTS5 实现
- 建立 `tm_fts` 虚拟表。
- `tm_entries` 更新时同步 FTS。
- 支持亚秒级全文检索。

### 3.2 UI 搜索面板
- 提供关键词搜索框。
- 显示匹配的 Source/Target 对，并支持点击应用。

---

## Phase 4: 集成与验收

- **Tag 安全**：破坏占位符立即报错，阻止导出。
- **TM (Working)**：Confirm 后自动入库，相同句 100% 命中。
- **传播**：确认一句后跨文件填充，支持撤销。
- **Concordance**：支持全文检索并应用。
- **性能**：万级数据操作无明显卡顿。
